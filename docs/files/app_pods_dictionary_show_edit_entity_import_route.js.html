<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>app/pods/dictionary/show/edit/entity/import/route.js - mdeditor</title>
    <meta name="description" content="Small description for mdeditor goes here">
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="stylesheet" href="../assets/css/custom.css">
    <link rel="stylesheet" href="../assets/vendor/bootstrap/css/bootstrap.css">
    <link rel="stylesheet" href="../assets/vendor/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="../assets/css/theme.css">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,500,600,700" rel="stylesheet" type="text/css">
    <link rel="shortcut icon" type="image/png" href="../assets/img/favicon.png">
    
</head>
<body>
    <nav class="navbar navbar-default">
      <div class="container-fluid">
        <div class="navbar-header">
          <a href="../" class="navbar-brand">
            <img src="../assets/img/mdeditor-logo.png" alt="">
            <span>API Docs</span>
          </a>
        </div>

        <div class="collapse navbar-collapse" id="nav">
          <ul class="nav navbar-nav navbar-right">
            <li><a href="https://github.com/adiwg/mdEditor" class="fa fa-github github"></a></li>
          </ul>
        </div>
      </div>
    </nav>
    <div id="main-wrapper" class="row">
        <div id="content-wrapper">
            <ol class="panel-group" id="sidebar" role="tablist" aria-multiselectable="true">
                <li class="panel panel-default">
                    <div class="panel-heading" role="tab" id="sidebar-search-heading">
                        <h4 class="panel-title">
                      <a role="button" data-toggle="collapse" href="#sidebar-search" aria-expanded="true" aria-controls="collapseOne">
                        Search
                      </a>
                    </h4>
                    </div>
                    <div id="sidebar-search" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="sidebar-search-heading">
                        <div class="panel-body">
                            <div id="api-tabview-filter">
                                <input type="search" id="api-filter" placeholder="Search...">
                            </div>
                        </div>
                    </div>
                </li>
                    <li class="panel panel-default">
                        <div class="panel-heading" role="tab" id="sidebar-version-heading">
                            <h4 class="panel-title">
                                <a role="button" href="https://github.com/adiwg/mdEditor/commits/6749337e" target="_blank">
                                  Tag: 0.9.0.6749337e
                                </a>
                            </h4>
                        </div>
                    </li>
                <li class="panel panel-default">
                    <div class="panel-heading" role="tab" id="sidebar-modules-heading">
                        <h4 class="panel-title">
                    <a role="button" data-toggle="collapse" href="#sidebar-modules" aria-expanded="true" aria-controls="collapseOne">
                      Modules
                    </a>
                  </h4>
                    </div>
                    <div id="sidebar-modules" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="sidebar-modules-heading">
                        <div class="panel-body">
                                <ol>
                                        <li>
                                            <a href="../modules/ember-json-tree.html">ember-json-tree</a>
                                                    <li class="sub"><a href="../modules/tree-view.html">tree-view</a></li>
                                                    <li class="sub"><a href="../modules/tree-search.html">tree-search</a></li>
                                                    <li class="sub"><a href="../modules/helpers.html">helpers</a></li>
                                        </li>
                                        <li>
                                            <a href="../modules/mdeditor.html">mdeditor</a>
                                                    <li class="sub"><a href="../modules/mixins.html">mixins</a></li>
                                                    <li class="sub"><a href="../modules/data-models.html">data-models</a></li>
                                                    <li class="sub"><a href="../modules/components-control.html">components-control</a></li>
                                                    <li class="sub"><a href="../modules/components-input.html">components-input</a></li>
                                                    <li class="sub"><a href="../modules/components-layout.html">components-layout</a></li>
                                                    <li class="sub"><a href="../modules/components-object.html">components-object</a></li>
                                        </li>
                                </ol>
                        </div>
                    </div>
                </li>
            
                <li class="panel panel-default">
                    <div class="panel-heading" role="tab" id="sidebar-classes-heading">
                        <h4 class="panel-title">
                      <a role="button" data-toggle="collapse" href="#sidebar-classes" aria-expanded="true" aria-controls="collapseOne">
                        Classes
                      </a>
                    </h4>
                    </div>
                    <div id="sidebar-classes" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="sidebar-classes-heading">
                        <div class="panel-body">
                            <ol>
                                    <li>
                                        <a href="../classes/contact.html">contact</a>
                                    </li>
                                    <li>
                                        <a href="../classes/make-range.html">make-range</a>
                                    </li>
                                    <li>
                                        <a href="../classes/md-address.html">md-address</a>
                                    </li>
                                    <li>
                                        <a href="../classes/md-array-table.html">md-array-table</a>
                                    </li>
                                    <li>
                                        <a href="../classes/md-boolean.html">md-boolean</a>
                                    </li>
                                    <li>
                                        <a href="../classes/md-button.html">md-button</a>
                                    </li>
                                    <li>
                                        <a href="../classes/md-button-modal.html">md-button-modal</a>
                                    </li>
                                    <li>
                                        <a href="../classes/md-card.html">md-card</a>
                                    </li>
                                    <li>
                                        <a href="../classes/md-citation.html">md-citation</a>
                                    </li>
                                    <li>
                                        <a href="../classes/md-citation-array.html">md-citation-array</a>
                                    </li>
                                    <li>
                                        <a href="../classes/md-codelist.html">md-codelist</a>
                                    </li>
                                    <li>
                                        <a href="../classes/md-codelist-multi.html">md-codelist-multi</a>
                                    </li>
                                    <li>
                                        <a href="../classes/md-contact-link.html">md-contact-link</a>
                                    </li>
                                    <li>
                                        <a href="../classes/md-contact-title.html">md-contact-title</a>
                                    </li>
                                    <li>
                                        <a href="../classes/md-date-range.html">md-date-range</a>
                                    </li>
                                    <li>
                                        <a href="../classes/md-datetime.html">md-datetime</a>
                                    </li>
                                    <li>
                                        <a href="../classes/md-definition.html">md-definition</a>
                                    </li>
                                    <li>
                                        <a href="../classes/md-edit-table.html">md-edit-table</a>
                                    </li>
                                    <li>
                                        <a href="../classes/md-graphic-array.html">md-graphic-array</a>
                                    </li>
                                    <li>
                                        <a href="../classes/md-identifier-array.html">md-identifier-array</a>
                                    </li>
                                    <li>
                                        <a href="../classes/md-identifier-object-table.html">md-identifier-object-table</a>
                                    </li>
                                    <li>
                                        <a href="../classes/md-import-csv.html">md-import-csv</a>
                                    </li>
                                    <li>
                                        <a href="../classes/md-input.html">md-input</a>
                                    </li>
                                    <li>
                                        <a href="../classes/md-input-confirm.html">md-input-confirm</a>
                                    </li>
                                    <li>
                                        <a href="../classes/md-maintenance.html">md-maintenance</a>
                                    </li>
                                    <li>
                                        <a href="../classes/md-markdown-editor.html">md-markdown-editor</a>
                                    </li>
                                    <li>
                                        <a href="../classes/md-object-table.html">md-object-table</a>
                                    </li>
                                    <li>
                                        <a href="../classes/md-online-resource-array.html">md-online-resource-array</a>
                                    </li>
                                    <li>
                                        <a href="../classes/md-phone-array.html">md-phone-array</a>
                                    </li>
                                    <li>
                                        <a href="../classes/md-scroll-spy.html">md-scroll-spy</a>
                                    </li>
                                    <li>
                                        <a href="../classes/md-select.html">md-select</a>
                                    </li>
                                    <li>
                                        <a href="../classes/md-select-contacts.html">md-select-contacts</a>
                                    </li>
                                    <li>
                                        <a href="../classes/md-select-table.html">md-select-table</a>
                                    </li>
                                    <li>
                                        <a href="../classes/md-select-thesaurus.html">md-select-thesaurus</a>
                                    </li>
                                    <li>
                                        <a href="../classes/md-simple-array-table.html">md-simple-array-table</a>
                                    </li>
                                    <li>
                                        <a href="../classes/md-spotlight.html">md-spotlight</a>
                                    </li>
                                    <li>
                                        <a href="../classes/md-textarea.html">md-textarea</a>
                                    </li>
                                    <li>
                                        <a href="../classes/md-toggle.html">md-toggle</a>
                                    </li>
                                    <li>
                                        <a href="../classes/md-wrap.html">md-wrap</a>
                                    </li>
                                    <li>
                                        <a href="../classes/object-template.html">object-template</a>
                                    </li>
                                    <li>
                                        <a href="../classes/tree-branch.html">tree-branch</a>
                                    </li>
                                    <li>
                                        <a href="../classes/tree-label.html">tree-label</a>
                                    </li>
                                    <li>
                                        <a href="../classes/tree-leaf.html">tree-leaf</a>
                                    </li>
                                    <li>
                                        <a href="../classes/tree-search.html">tree-search</a>
                                    </li>
                                    <li>
                                        <a href="../classes/tree-view.html">tree-view</a>
                                    </li>
                            </ol>
                        </div>
                    </div>
                </li>
            </ol>
            <div class="content-container">
                <div class="apidocs">
                    <div id="docs-main">
                        <div class="content">
<div class="page-header">
    <h1><i class="fa fa-file-code-o" aria-hidden="true"></i>  File</h1>
</div>

<div class="file">
    <pre class="prettyprint linenums">
import Route from &#x27;@ember/routing/route&#x27;;
import {
  max,
  min,
  equal,
  not,
  gt
} from &#x27;@ember/object/computed&#x27;;
import {
  typeOf,
  isPresent,
  isBlank
} from &#x27;@ember/utils&#x27;;
import EmberObject from &#x27;@ember/object&#x27;;
import uuidV4 from &quot;uuid/v4&quot;;

import {
  get,
  getWithDefault,
  set,
  computed
} from &#x27;@ember/object&#x27;;

export default Route.extend({
  setupController(controller, model) {
    // Call _super for default behavior
    this._super(controller, model);
    // Implement your custom setup after
    controller.set(&#x27;entity&#x27;, EmberObject.create({
      entityId: uuidV4(),
      attribute: []
    }));
  },

  /**
   * The template object for columns
   *
   * @property columnObject
   * @type {Ember.Object}
   * @static
   * @readOnly
   */
  columnObject: EmberObject.extend({
    domain: null,
    import: true,
    range: false,
    importName: null,
    importType: null,
    min: min(&#x27;domain&#x27;),
    max: max(&#x27;domain&#x27;),
    domainWarn: gt(&#x27;domain.length&#x27;, 50),
    isNumber: equal(&#x27;dataType&#x27;, &#x27;number&#x27;),
    disableRange: not(&#x27;isNumber&#x27;),
    example: computed(&#x27;domain&#x27;, function () {
      return this.domain.slice(0, 10);
    })
  }),

  /**
   * Returns the dataType code value for the JavaScript type.
   *
   * @method columnType
   * @param {string} type The JavaScript type
   * @return {string}
   */
  columnType(type) {
    return {
      &#x27;string&#x27;: &#x27;character varying&#x27;,
      &#x27;number&#x27;: &#x27;numeric&#x27;,
      &#x27;boolean&#x27;: &#x27;boolean&#x27;,
      &#x27;integer&#x27;: &#x27;integer&#x27;
    }[type] || &#x27;unknown&#x27;;
  },

  createAttribute(columnName, column) {
    let domain = get(column, &#x27;hasDomain&#x27;) ? EmberObject.create({
      domainId: uuidV4(),
      codeName: columnName,
      domainItem: get(column, &#x27;domain&#x27;).filter(i =&gt; isPresent(i)).map(
        (itm) =&gt; {
          return {
            name: itm.toString(),
            value: itm.toString(),
            definition: null
          };
        })
    }) : false;

    let attribute = {
      codeName: column.importName,
      dataType: column.importType,
      allowNull: column.allowNull,
      maxValue: column.get(&#x27;range&#x27;) ? column.get(&#x27;max&#x27;).toString() : null,
      minValue: column.get(&#x27;range&#x27;) ? column.get(&#x27;min&#x27;).toString() : null,
      domainId: domain ? get(domain, &#x27;domainId&#x27;) : null
    };

    return {
      attribute: attribute,
      domain: domain
    };
  },

  generateData() {
    let columns = this.get(&#x27;controller.columns&#x27;);
    let domains = [];
    let attributes = [];

    Object.keys(columns).forEach((columnName) =&gt; {
      let col = columns[columnName];

      if(!col.import) {
        return;
      }

      let attr = this.createAttribute(columnName, col);

      attributes.pushObject(attr.attribute);

      if(attr.domain) {
        domains.pushObject(attr.domain);
      }

    });

    return {
      attributes: attributes,
      domains: domains
    };
  },

  actions: {
    cancelImport() {
      set(this, &#x27;controller.columns&#x27;, null);
      set(this, &#x27;controller.processed&#x27;, false);
    },
    goToEntity(){
      this.transitionTo(&#x27;dictionary.show.edit.entity&#x27;);
    },
    doImport() {
      let data = this.generateData();
      let entity = this.get(&#x27;controller.entity&#x27;);
      let dataDictionary = this.get(&#x27;controller.model.json.dataDictionary&#x27;);

      if(get(data,&#x27;domains.length&#x27;)) {
        set(dataDictionary,&#x27;domain&#x27;, getWithDefault(dataDictionary,
          &#x27;domain&#x27;, []));

        set(dataDictionary, &#x27;domain&#x27;, get(dataDictionary, &#x27;domain&#x27;).concat(data.domains));
      }

      set(dataDictionary,&#x27;entity&#x27;, getWithDefault(dataDictionary, &#x27;entity&#x27;, []));
      set(entity, &#x27;attribute&#x27;, data.attributes);
      get(dataDictionary, &#x27;entity&#x27;).push(entity);

      this.transitionTo(&#x27;dictionary.show.edit.entity.edit&#x27;, get(
        dataDictionary, &#x27;entity.length&#x27;) - 1);

        this.flashMessages
          .success(&#x27;Entity imported from CSV!&#x27;);
    },
    processData(data) {
      let template = this.columnObject;
      let typer = this.columnType;

      set(this, &#x27;controller.processed&#x27;, false);

      set(this, &#x27;controller.columns&#x27;, data.meta.fields.reduce(function (map,
        obj) {
        let type = typeOf(data.data[0][obj]);

        set(map, obj, template.create({
          dataType: type,
          domain: [],
          importName: obj,
          importType: typer(type)
        }));
        return map;
      }, EmberObject.create({})));
    },
    reduceData(data) {
      let columns = Object.keys(this.get(&#x27;controller.columns&#x27;));

      columns.forEach((columnName) =&gt; {
        let path = &#x27;controller.columns.&#x27; + columnName + &#x27;.domain&#x27;;
        let existing = get(this, path);

        // if(get(existing,&#x27;length&#x27; )&lt;= get(this,&#x27;maxDomain&#x27;)){
        let unique = [...new Set(data.map(item =&gt; item[columnName]))];

        set(this, path, [...new Set([...existing, ...unique])]);
        // }
      });

    },
    processComplete() {
      let columns = this.get(&#x27;controller.columns&#x27;);
      let columnNames = Object.keys(columns);

      columnNames.forEach((columnName) =&gt; {
        let col = columns[columnName];

        if(col.importType === &#x27;numeric&#x27;) {
          let isInteger = col.domain.any(itm =&gt; Number.isInteger(itm));

          col.importType = isInteger ? &#x27;integer&#x27; : &#x27;numeric&#x27;;
        }

        col.allowNull = col.domain.any(itm =&gt; isBlank(itm));
      });

      set(this, &#x27;controller.processed&#x27;, true);

    }
  }
});

    </pre>
</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="../assets/vendor/prettify/prettify-min.js"></script>
    <script>prettyPrint();</script>
    <script src="../assets/vendor/jquery/jquery.min.js"></script>
    <script src="../assets/vendor/jquery-ui/jquery-ui.min.js"></script>
    <script src="../assets/vendor/bootstrap/js/bootstrap.js"></script>
    <script src="../assets/vendor/github-slugger/slugger.js"></script>
    <script src="../assets/js/yuidoc-bootstrap.js"></script>
</body>
</html>
